<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>All Players</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
      /* General table styling */
      table {
        font-size: 0.95rem;
      }

      /* Reduce table cell padding for compact display */
      table.table td,
      table.table th {
        padding: 0.25rem 0.35rem; /* tighter padding */
        line-height: 1.1; /* tighter row spacing */
      }

      /* Reduce spacing for headings */
      h4 {
        margin-top: 0.75rem;
        margin-bottom: 0.25rem;
      }

      /* Reduce vertical spacing for Save & Reset button */
      #resetPlayersBtn {
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
      }

      /* Specific styling for Unsold table to make it even more compact */
      #playersTable table:last-of-type td,
      #playersTable table:last-of-type th {
        padding: 0.2rem 0.3rem;
        line-height: 1.05;
      }

      #playersTable table:last-of-type {
        margin-bottom: 1rem;
      }

      /* Flex container for top header */
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .page-header h2 {
        margin: 0 auto;
        text-align: center;
        flex: 1;
      }

      .back-btn {
        flex: 0;
      }
      .btn-bck{
        margin: 10px;
      }
    </style>
  </head>

  <body>
    <div class="container mt-4">
      <!-- Header with centered title and right-aligned button -->
      <div class="page-header">
        <div></div>
        <!-- Empty div to balance spacing -->
        <h2>All Players (Grouped by Team)</h2>
        <a href="/index.html" class="btn btn-light back-btn btn-bck"><i class="fa-solid fa-left-long"></i></a>
        <a href="/teams.html" class="btn btn-light back-btn btn-bck"><i class="fa-solid fa-right-long"></i></i></a>
      </div>

      <div id="playersSection">
        <div id="playersTable"></div>

        <div class="text-center my-4">
          <button id="resetPlayersBtn" class="btn btn-warning btn-lg">
            ðŸ’¾ Save & Reset Players
          </button>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:5000";

      async function loadPlayers() {
        const res = await fetch(`${API_URL}/players`);
        const players = await res.json();

        const teams = {
          "IMJ NINJAS": [],
          "IMJ IGNITORS": [],
          "IMJ TITANS": [],
          "IMJ FALCONS": [],
          "IMJ PHANTOMS": [],
          "IMJ HAWKS": [],
        };
        const unsoldPlayers = [];

        players.forEach((p) => {
          if (p.sold && p.team && p.team.name) {
            teams[p.team.name].push(p);
          } else {
            unsoldPlayers.push(p);
          }
        });

        let html = "";

        // Teams Table
        Object.keys(teams).forEach((teamName) => {
          html += `<h4 class="mt-4 text-center">${teamName}</h4>`;
          html += `<div class="table-responsive">
            <table class="table table-sm table-striped table-bordered table-hover ">
              <thead class="table-dark">
                <tr>
                  <th>Name</th>
                  <th>Class</th>
                  <th>Base Price</th>
                  <th>Sold</th>
                  <th>Team</th>
                  <th>Sold Price</th>
                </tr>
              </thead>
              <tbody>`;

          if (teams[teamName].length > 0) {
            teams[teamName].forEach((p) => {
              html += `<tr>
                <td>${p.name}</td>
                <td>${p.className}</td>
                <td>${p.basePrice}</td>
                <td>âœ… Yes</td>
                <td>${p.team.name}</td>
                <td>${p.soldPrice}</td>
              </tr>`;
            });
          } else {
            html += `<tr><td colspan="6" class="text-center">No players yet</td></tr>`;
          }

          html += `</tbody></table></div>`;
        });

        // Unsold Players Table (Compact)
        html += `<h4 class="mt-3 text-center">Unsold Players</h4>`;
        html += `<div class="table-responsive">
          <table class="table table-sm table-striped table-bordered table-hover">
            <thead class="table-dark">
              <tr>
                <th>Name</th>
                <th>Class</th>
                <th>Base Price</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>`;

        if (unsoldPlayers.length > 0) {
          unsoldPlayers.forEach((p) => {
            html += `<tr>
              <td>${p.name}</td>
              <td>${p.className}</td>
              <td>${p.basePrice}</td>
              <td>
                <button class="btn btn-danger btn-sm" onclick="deletePlayer('${p._id}')">
                  Delete
                </button>
              </td>
            </tr>`;
          });
        } else {
          html += `<tr><td colspan="4" class="text-center">No unsold players</td></tr>`;
        }

        html += `</tbody></table></div>`;

        document.getElementById("playersTable").innerHTML = html;
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadPlayers();

        document
          .getElementById("resetPlayersBtn")
          .addEventListener("click", async () => {
            try {
              /* >>>  CALL THE NEW CHECKPOINT ROUTE  <<< */
              const res = await fetch(`${API_URL}/auction/checkpoint`, {
                method: "POST",
              });
              const data = await res.json();
              alert(data.message);
              /* refresh the page to show the saved state */
              await loadPlayers();
            } catch (err) {
              alert("Error: " + err.message);
            }
          });
      });

      async function deletePlayer(playerId) {
        if (!confirm("Are you sure you want to delete this unsold player?"))
          return;

        try {
          const res = await fetch(`${API_URL}/player/${playerId}`, {
            method: "DELETE",
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Failed to delete player");

          alert(data.message);
          await loadPlayers();
        } catch (err) {
          alert("Error: " + err.message);
        }
      }
    </script>
  </body>
</html>
