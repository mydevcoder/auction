<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player Auction</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #a09b9b94;
      }
      .nav-style {
        font-size: 1.5rem;
      }
      .navbar-nav a {
        padding: 10px 40px !important;
      }
      .container-md {
        display: block;
        width: 80vw;
        height: auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(14, 13, 13, 0.644);
      }
      .design-input {
        border: 2px solid rgb(29, 28, 28);
      }
      .row {
        margin-left: 19vw;
      }
      .drop-btn {
        width: 120px !important;
      }
      .bid-btn {
        width: 16vw;
        height: 6vh;
      }
      .row-three {
        margin-left: 19vw;
      }
      .btn-left {
        margin-left: 9vw;
      }
      .btn-right {
        margin-left: -1vw;
      }
      .clr-btn {
        width: 6vw;
        margin-top: 50px;
        margin-left: -10px;
      }
      .alert-sm {
        font-size: 0.9rem;
        padding: 6px 10px;
        margin-bottom: 6px;
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-md bg-body-light nav-style">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="fa-solid fa-ranking-star"></i>
        </a>
        <button
          class="navbar-toggler"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNavAltMarkup"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <a class="nav-link" href="players.html"><b>All_players</b></a>
            <a class="nav-link" href="teams.html"><b>Team</b></a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Auction Container -->
    <div class="container-md mt-4">
      <h1 class="text-center"><b>IMJISC Premiere League</b></h1>
      <h4 class="text-center">Player Auction</h4>

      <div class="row-details">
        <!-- Player Input -->
        <div class="row mb-3 input-field">
          <div class="mt-3 col-md-7">
            <div class="form-floating">
              <input
                type="text"
                class="form-control design-input"
                id="playerName"
                placeholder="Enter new player"
              />
              <label>Enter new player</label>
            </div>
          </div>
          <div class="class mt-5 col-md-2">
            <select
              id="classSelect"
              class="form-control btn btn-dark dropdown-toggle drop-btn"
            >
              <option value="">Select Class</option>
              <option>III BCA</option>
              <option>III BCOM</option>
              <option>III BBA</option>
              <option>II BCA</option>
              <option>II BCOM</option>
              <option>II BBA</option>
              <option>I BCA</option>
              <option>I BCOM</option>
              <option>I BBA</option>
            </select>
          </div>
        </div>

        <!-- Bid Input -->
        <div class="row">
          <div class="mt-0 col-md-7">
            <div class="form-floating">
              <input
                type="number"
                class="form-control design-input"
                id="bidPrice"
                min="200"
                placeholder="Bid Amount"
              />
              <label>Bid Price</label>
            </div>
          </div>
          <div class="mt-3 col-md-2">
            <button type="button" id="enterBtn" class="btn btn-dark drop-btn">
              Enter
            </button>
          </div>
        </div>

        <!-- Team & Bid -->
        <div class="row mb-3">
          <div class="class mt-3 col-md-2 btn-left">
            <select
              id="teamSelect"
              class="form-control btn btn-dark dropdown-toggle drop-btn"
            >
              <option value="">Select Team</option>
              <option>IMJ NINJAS</option>
              <option>IMJ IGNITORS</option>
              <option>IMJ TITANS</option>
              <option>IMJ FALCONS</option>
              <option>IMJ PHANTOMS</option>
              <option>IMJ HAWKS</option>
            </select>
          </div>
          <div class="mt-3 col-md-2 btn-right">
            <button type="button" class="btn btn-dark" id="bidBtn">
              Bid Player
            </button>
          </div>
        </div>

        <!-- Finalize & Drop -->
        <div class="row mt-3 row-three">
          <div class="mt-3 col-md-4">
            <button type="button" class="btn btn-success bid-btn" id="winBtn">
              Won Player
            </button>
          </div>
          <div class="mt-3 col-md-3">
            <button type="button" class="btn btn-danger bid-btn" id="dropBtn">
              Drop Player
            </button>
          </div>
        </div>

        <!-- Clear -->
        <button type="button" class="btn btn-danger clr-btn" id="clearBtn">
          Clear
        </button>
      </div>

      <!-- Stats -->
      <div class="row mt-4">
        <div class="col-md-4">
          <label><b>Total Credits:</b></label>
          <span id="totalCredits">10000</span>
        </div>
        <div class="col-md-4">
          <label><b>Used Credits:</b></label>
          <span id="usedCredits">0</span>
        </div>
        <div class="col-md-4">
          <label><b>Players:</b></label>
          <span id="playerCount">0 / 26</span>
        </div>
      </div>
    </div>

    <!-- Script -->
    <script defer>
      const API_BASE = "https://auction-jg8t.onrender.com"; // Render backend URL
      let currentAuctionId = null;
      const $ = (id) => document.getElementById(id);

      const alertBox = (msg, success = false) => {
        const wrap = document.createElement("div");
        wrap.className = `alert alert-${
          success ? "success" : "danger"
        } alert-sm mt-2`;
        wrap.textContent = msg;
        const container = document.querySelector(".row-details");
        if (container) container.prepend(wrap);
        setTimeout(() => wrap.remove(), 3000);
      };

      async function pingServer() {
        try {
          const res = await fetch(`${API_BASE}/players`);
          return res.ok;
        } catch {
          return false;
        }
      }

      async function addPlayer() {
        const name = $("playerName").value.trim();
        const className = $("classSelect").value;
        if (!name || !className)
          return alertBox("Player name and class required");

        $("enterBtn").disabled = true;
        try {
          if (!(await pingServer())) throw new Error("Server not reachable");

          const res = await fetch(`${API_BASE}/auction/new`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, className, basePrice: 200 }),
          });

          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Failed to start auction");

          currentAuctionId = data.auction?._id;
          alertBox(`Auction started for “${data.player.name}”`, true);
          $("bidPrice").value = data.player.basePrice || 200;
        } catch (err) {
          alertBox(err.message);
        } finally {
          $("enterBtn").disabled = false;
        }
      }

      async function placeBid() {
        if (!currentAuctionId) return alertBox("No auction running!");
        const bidAmount = Number($("bidPrice").value) || 0;
        const teamName = $("teamSelect").value;
        if (!teamName) return alertBox("Select a team");

        try {
          const teamRes = await fetch(
            `${API_BASE}/team/byName/${encodeURIComponent(teamName)}`
          );
          const team = await teamRes.json();
          if (!teamRes.ok || team.error) throw new Error("Team not found");

          const res = await fetch(
            `${API_BASE}/auction/bid/${currentAuctionId}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ teamId: team._id, bidAmount }),
            }
          );

          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Bid failed");
          alertBox(`Bid placed: ${data.currentBid}`, true);
        } catch (err) {
          alertBox(err.message);
        }
      }

      async function finalizeAuction() {
        if (!currentAuctionId) return alertBox("No auction running!");
        try {
          const res = await fetch(
            `${API_BASE}/auction/finalize/${currentAuctionId}`,
            { method: "POST" }
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Finalization failed");

          alertBox(`Player won by ${data.team.name}`, true);
          updateTeamStats(data.team);
          currentAuctionId = null;
          $("playerName").value = "";
          $("bidPrice").value = "";
          $("classSelect").selectedIndex = 0;
          $("teamSelect").selectedIndex = 0;
        } catch (err) {
          alertBox(err.message);
        }
      }

      async function dropPlayer() {
        if (!currentAuctionId) return alertBox("No auction running!");
        try {
          const res = await fetch(
            `${API_BASE}/auction/drop/${currentAuctionId}`,
            { method: "POST" }
          );
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Drop failed");

          alertBox(data.message, true);
          currentAuctionId = null;
          $("playerName").value = "";
          $("bidPrice").value = "";
          $("classSelect").selectedIndex = 0;
          $("teamSelect").selectedIndex = 0;
        } catch (err) {
          alertBox(err.message);
        }
      }

      function updateTeamStats(team) {
        $("totalCredits").textContent = team.credits;
        $("usedCredits").textContent = team.usedCredits || 0;
        $("playerCount").textContent = `${team.players?.length || 0} / 26`;
      }

      $("clearBtn").addEventListener("click", () => {
        $("playerName").value = "";
        $("bidPrice").value = "";
        $("classSelect").selectedIndex = 0;
        $("teamSelect").selectedIndex = 0;
        currentAuctionId = null;
      });

      $("teamSelect").addEventListener("change", async (e) => {
        const teamName = e.target.value;
        if (!teamName) return;
        try {
          const res = await fetch(
            `${API_BASE}/team/byName/${encodeURIComponent(teamName)}`
          );
          const team = await res.json();
          if (res.ok && !team.error) updateTeamStats(team);
        } catch {}
      });

      $("playerName").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addPlayer();
        }
      });
      $("bidPrice").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          placeBid();
        }
      });

      const bidInput = $("bidPrice");
      const getStep = (v) => (v >= 1500 ? 50 : 100);
      bidInput.addEventListener("keydown", (e) => {
        if (e.key !== "ArrowUp" && e.key !== "ArrowDown") return;
        e.preventDefault();
        const val = Number(bidInput.value) || 0;
        const step = getStep(val);
        bidInput.value = val + (e.key === "ArrowUp" ? 1 : -1) * step;
      });
      bidInput.addEventListener("change", () => {
        const val = Number(bidInput.value) || 0;
        const step = getStep(val);
        bidInput.value = Math.round(val / step) * step;
      });

      $("enterBtn").addEventListener("click", addPlayer);
      $("bidBtn").addEventListener("click", placeBid);
      $("winBtn").addEventListener("click", finalizeAuction);
      $("dropBtn").addEventListener("click", dropPlayer);

      console.log("Auction page loaded. API_BASE:", API_BASE);
    </script>
  </body>
</html>
