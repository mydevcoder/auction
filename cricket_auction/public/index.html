<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #a09b9b94;
      }
      .nav-style {
        font-size: 1.5rem;
      }
      .navbar-nav a {
        padding: 10px 40px !important;
      }
      .base-label {
        font-size: large;
      }
      .container-md {
        display: block;
        width: 80vw;
        height: auto;
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(14, 13, 13, 0.644);
      }
      .design-input {
        border: 2px solid rgb(29, 28, 28);
      }
      .row {
        margin-left: 19vw;
      }
      .drop-btn {
        width: 120px !important;
      }
      .bid-btn {
        width: 16vw;
        height: 6vh;
      }
      .row-three {
        margin-left: 19vw;
      }
      .btn-left {
        margin-left: 9vw;
      }
      .btn-right {
        margin-left: -1vw;
      }
      .clr-btn {
        width: 6vw;
        margin-top: 50px;
        margin-left: -10px;
      }
    </style>
    <title>Player Auction</title>
  </head>

  <body>
    <nav class="navbar navbar-expand-md bg-body-light nav-style">
      <div class="container-fluid">
        <a class="navbar-brand" href="/"
          ><i class="fa-solid fa-ranking-star"></i
        ></a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNavAltMarkup"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav">
            <a class="nav-link" href="players.html"><b>All_players</b></a>
            <a class="nav-link" href="teams.html"><b>Team</b></a>
          </div>
        </div>
      </div>
    </nav>

    <div class="container-md mt-4">
      <div class="heading">
        <h1 class="text-center"><b>IMJISC Premiere League</b></h1>
        <h4 class="text-center">Player Auction</h4>
      </div>

      <div class="row-details">
        <div class="row mb-3 input-field">
          <div class="mt-3 col-md-7">
            <div class="input-group mt-3 mb-3">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control design-input"
                  id="playerName"
                  placeholder="Enter new player"
                />
                <label for="playerName">Enter new player</label>
              </div>
            </div>
            <div class="invalid-feedback">Enter a valid player</div>
          </div>
          <div class="class mt-5 col-md-2">
            <select
              id="classSelect"
              class="form-control btn btn-dark dropdown-toggle drop-btn"
            >
              <option value="">Select Class</option>
              <option value="III BCA">III BCA</option>
              <option value="III BCOM">III BCOM</option>
              <option value="III BBA">III BBA</option>
              <option value="II BCA">II BCA</option>
              <option value="II BCOM">II BCOM</option>
              <option value="II BBA">II BBA</option>
              <option value="I BCA">I BCA</option>
              <option value="I BCOM">I BCOM</option>
              <option value="I BBA">I BBA</option>
            </select>
            <div class="invalid-feedback">Enter a valid class</div>
          </div>
        </div>

        <div class="row">
          <div class="mt-0 col-md-7">
            <div class="input-group mt-20 mb-3">
              <div class="form-floating">
                <input
                  type="number"
                  class="form-control design-input"
                  id="bidPrice"
                  min="200"
                  placeholder="Bid Amount"
                />
                <label for="bidPrice">Bid Price</label>
              </div>
            </div>
            <div class="invalid-feedback">Enter a valid Points</div>
          </div>
          <div class="mt-3 col-md-2">
            <button
              type="button"
              class="btn btn-dark drop-btn"
              onclick="addPlayer()"
            >
              Enter
            </button>
          </div>
        </div>

        <div class="row mb-3">
          <div class="class mt-3 col-md-2 btn-left">
            <select
              id="teamSelect"
              class="form-control btn btn-dark dropdown-toggle drop-btn"
            >
              <option value="">Select Team</option>
              <option value="IMJ NINJAS">IMJ NINJAS</option>
              <option value="IMJ IGNITORS">IMJ IGNITORS</option>
              <option value="IMJ TITANS">IMJ TITANS</option>
              <option value="IMJ FALCONS">IMJ FALCONS</option>
              <option value="IMJ PHANTOMS">IMJ PHANTOMS</option>
              <option value="IMJ HAWKS">IMJ HAWKS</option>
            </select>
            <div class="invalid-feedback">Enter a valid team name</div>
          </div>
          <div class="mt-3 col-md-2 btn-right">
            <button type="button" class="btn btn-dark" onclick="placeBid()">
              Bid Player
            </button>
          </div>
        </div>

        <div class="row mt-3 row-three">
          <div class="mt-3 col-md-4">
            <button
              type="button"
              class="btn btn-success bid-btn"
              onclick="finalizeAuction()"
            >
              Won Player
            </button>
          </div>
          <div class="mt-3 col-md-3">
            <button
              type="button"
              class="btn btn-danger bid-btn"
              onclick="dropPlayer()"
            >
              Drop Player
            </button>
          </div>
        </div>

        <button type="button" class="btn btn-danger clr-btn" id="clearBtn">
          Clear
        </button>
      </div>

      <!-- Team Stats Section -->
      <div class="row mt-4">
        <div class="col-md-4">
          <label><b>Total Credits:</b></label>
          <span id="totalCredits">10000</span>
        </div>
        <div class="col-md-4">
          <label><b>Used Credits:</b></label>
          <span id="usedCredits">0</span>
        </div>
        <div class="col-md-4">
          <label><b>Players:</b></label>
          <span id="playerCount">0 / 26</span>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_BASE = "https://auction-jg8t.onrender.com";
      let currentAuctionId = null;

      async function addPlayer() {
        const name = document.getElementById("playerName").value;
        const className = document.getElementById("classSelect").value;
        const basePrice = 200;

        const res = await fetch(`${API_BASE}/auction/new`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, className, basePrice }),
        });

        const data = await res.json();
        if (data.error) return alert("Error: " + data.error);

        currentAuctionId = data.auction._id;
        alert(
          `Auction Started for Player: ${data.player.name} (Base Price: ${data.player.basePrice})`
        );
      }

      async function placeBid() {
        if (!currentAuctionId) return alert("No auction running!");
        const bidAmount =
          Number(document.getElementById("bidPrice").value) || 0;
        const teamName = document.getElementById("teamSelect").value;
        if (!teamName) return alert("Please select a team!");

        const teamRes = await fetch(
          `${API_BASE}/team/byName/${encodeURIComponent(teamName)}`
        );
        const team = await teamRes.json();
        if (!teamRes.ok || team.error)
          return alert(team.error || "Team not found");

        const res = await fetch(`${API_BASE}/auction/bid/${currentAuctionId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ teamId: team._id, bidAmount }),
        });
        const data = await res.json();
        if (data.error) alert(data.error);
        else alert("Bid Placed: " + data.currentBid);
      }

      async function finalizeAuction() {
        if (!currentAuctionId) return alert("No auction running!");
        const res = await fetch(
          `${API_BASE}/auction/finalize/${currentAuctionId}`,
          { method: "POST" }
        );
        const data = await res.json();
        alert("Auction Finalized! Player sold to " + data.team.name);
        if (data.team) updateTeamStats(data.team);
        currentAuctionId = null;
      }

      async function dropPlayer() {
        if (!currentAuctionId) return alert("No auction running!");
        const res = await fetch(
          `${API_BASE}/auction/drop/${currentAuctionId}`,
          { method: "POST" }
        );
        const data = await res.json();
        alert(data.message);

        currentAuctionId = null;
        document.getElementById("playerName").value = "";
        document.getElementById("bidPrice").value = 200;
        document.getElementById("classSelect").selectedIndex = 0;
        document.getElementById("teamSelect").selectedIndex = 0;
      }

      document.getElementById("clearBtn").addEventListener("click", () => {
        document.getElementById("playerName").value = "";
        document.getElementById("bidPrice").value = "";
        document.getElementById("classSelect").selectedIndex = 0;
        document.getElementById("teamSelect").selectedIndex = 0;
        currentAuctionId = null;
      });

      function updateTeamStats(team) {
        document.getElementById("totalCredits").textContent = team.credits;
        document.getElementById("usedCredits").textContent =
          team.usedCredits || 0;
        document.getElementById("playerCount").textContent =
          team.players.length + " / 26";
      }

      document
        .getElementById("teamSelect")
        .addEventListener("change", async (e) => {
          const teamName = e.target.value;
          if (!teamName) return;

          const res = await fetch(
            `${API_BASE}/team/byName/${encodeURIComponent(teamName)}`
          );
          const team = await res.json();
          if (res.ok && !team.error) updateTeamStats(team);
        });

      // ✅ Handle Enter key for playerName
      document.getElementById("playerName").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addPlayer();
        }
      });

      // ✅ Handle Enter key for bidPrice
      document.getElementById("bidPrice").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          placeBid();
        }
      });

      // Arrow key handling for bidPrice input
      const bidInput = document.getElementById("bidPrice");
      function getStep(value) {
        return value >= 1500 ? 50 : 100;
      }
      bidInput.addEventListener("keydown", (e) => {
        if (e.key !== "ArrowUp" && e.key !== "ArrowDown") return;
        e.preventDefault();
        const value = Number(bidInput.value) || 0;
        const step = getStep(value);
        bidInput.value = value + (e.key === "ArrowUp" ? 1 : -1) * step;
      });
      bidInput.addEventListener("change", () => {
        const value = Number(bidInput.value) || 0;
        const step = getStep(value);
        bidInput.value = Math.round(value / step) * step;
      });
    </script>
  </body>
</html>
